<?php

/**
 * Implements hook_menu().
 */
function baumspenden_menu()
{
    $items['baumspende'] = array(
        'title' => 'Baumspende',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('baumspenden_donation'),
        'access arguments' => array('access baumspenden donation form'),
    );

    return $items;
}

/**
 * Builds the "baumspenden_donation" form.
 *
 * @param $form
 * @param $form_state
 *
 * @return mixed
 */
function baumspenden_donation($form, &$form_state)
{
    $form['amount'] = array(
        '#type' => 'textfield',
        '#title' => 'Ich spende',
        '#description' => 'Für mehr als 100 Bäume und Unternehmensspenden kontaktieren Sie uns bitte unter <a href="mailto:baumspende@bergwaldprojekt.de">baumspende@bergwaldprojekt.de</a>',
        '#field_suffix' => 'Baum/Bäume',
        '#required' => true,
    );

    $form['plant_info'] = array(
        '#prefix' => '<div id="baumspenden-plant-info">',
        '#suffix' => '</div>',
    );

    $form['plant_info']['plant_period'] = array(
        '#type' => 'select',
        '#title' => 'Pflanzperiode',
        '#options' => DrupalBaumspendenConfig::getPlantPeriods(),
        '#empty_option' => '- Auswählen -',
        '#required' => true,
        '#ajax' => array(
            'wrapper' => 'baumspenden-plant-info',
            'callback' => '_baumspenden_donation_plant_info',
        ),
    );

    if (isset($form_state['values']['plant_period'])) {
        $form['plant_info']['plant_region'] = array(
            '#type' => 'select',
            '#title' => 'Region',
            '#options' => DrupalBaumspendenConfig::getPlantRegions(
                $form_state['values']['plant_period']
            ),
            '#required' => true,
            '#ajax' => array(
                'wrapper' => 'baumspenden-plant-info',
                'callback' => '_baumspenden_donation_plant_info',
            ),
        );
    }
    if (isset($form_state['values']['plant_region'])) {
        $form['plant_info']['plant_tree'] = array(
            '#type' => 'select',
            '#title' => 'Baumart',
            '#options' => DrupalBaumspendenConfig::getTreeSpecies(
                $form_state['values']['plant_period']
            ),
            '#required' => true,
        );
    }
    $form['plant_info']['update'] = array(
        '#type' => 'submit',
        '#value' => t('Update'),
        '#attributes' => array(
            'class' => array(
                'hide-js',
            ),
        ),
        '#attached' => array(
            'css' => array(
                drupal_get_path('module', 'baumspenden') . '/css/baumspende.css',
            ),
        ),
        '#limit_validation_errors' => array(
            array('plant_period'),
            array('plant_region'),
        ),
        '#submit' => array(
            'baumspenden_donation_submit',
        ),
    );

    $form['contact'] = array(
        '#type' => 'fieldset',
        '#title' => 'Meine Kontaktdaten',
    );
    $form['contact']['first_name'] = array(
        '#type' => 'textfield',
        '#title' => 'Vorname',
        '#required' => true,
    );
    $form['contact']['last_name'] = array(
        '#type' => 'textfield',
        '#title' => 'Nachname',
        '#required' => true,
    );
    $form['contact']['street_address'] = array(
        '#type' => 'textfield',
        '#title' => 'Straße, Hausnummer',
        '#required' => true,
    );
    $form['contact']['postal_code'] = array(
        '#type' => 'textfield',
        '#title' => 'Postleitzahl',
        '#required' => true,
    );
    $form['contact']['city'] = array(
        '#type' => 'textfield',
        '#title' => 'Ort',
        '#required' => true,
    );
    $form['contact']['email'] = array(
        '#type' => 'textfield',
        '#title' => 'E-Mail-Adresse',
        '#required' => true,
    );

    $form['shipping_mode'] = array(
        '#type' => 'select',
        '#title' => 'Versandoption',
        '#options' => array(
            'email' => 'als PDF per E-Mail',
            'postal' => 'postalisch',
            'none' => 'kein Zertifikat',
        ),
    );
    $form['certificate_name'] = array(
        '#type' => 'textfield',
        '#title' => 'Name auf Zertifikat',
        '#description' => 'max. 40 Zeichen',
    );

    $form['newsletter'] = array(
        '#type' => 'checkbox',
        '#title' => 'Newsletter abonnieren',
        '#description' => 'Newsletter mit aktuellen Themen rund um das Bergwaldprojekt',
    );
    $form['gdpr_consent'] = array(
        '#type' => 'checkbox',
        '#title' => 'Datenschutz',
        '#description' => 'Ich habe die <a href="' . variable_get(
                'baumspenden_gdpr_link',
                '/datenschutz'
            ) . '" target="_blank">Datenschutzerklärung</a> gelesen und akzeptiere diese.',
    );

    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => 'Vorschau',
    );

    return $form;
}

function baumspenden_donation_submit($form, &$form_state) {
    switch ($form_state['triggering_element']['#value']) {
        case $form['submit']['#value']:
            // TODO: Process form.
            break;
        case $form['plant_info']['update']['#value']:
            $form_state['rebuild'] = true;
            break;
    }
}

function _baumspenden_donation_plant_info($form) {
    return $form['plant_info'];
}
