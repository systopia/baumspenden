<?php

/**
 * Implements hook_menu().
 */
function baumspenden_menu()
{
    $items['baumspende'] = [
        'title' => 'Baumspende',
        'page callback' => 'drupal_get_form',
        'page arguments' => ['baumspenden_donation'],
        'access arguments' => ['access baumspenden donation form'],
    ];

    return $items;
}

/**
 * Builds the "baumspenden_donation" form.
 *
 * @param $form
 * @param $form_state
 *
 * @return mixed
 */
function baumspenden_donation($form, &$form_state)
{
    $form['amount'] = [
        '#type' => 'textfield',
        '#title' => 'Ich spende',
        '#description' => 'Für mehr als 100 Bäume und Unternehmensspenden kontaktieren Sie uns bitte unter <a href="mailto:baumspende@bergwaldprojekt.de">baumspende@bergwaldprojekt.de</a>',
        '#field_suffix' => 'Baum/Bäume',
        '#required' => true,
        '#element_validate' => [
            'element_validate_integer_positive',
        ],
    ];

    $form['plant_info'] = [
        '#prefix' => '<div id="baumspenden-plant-info">',
        '#suffix' => '</div>',
    ];
    $form['plant_info']['plant_period'] = [
        '#type' => 'select',
        '#title' => 'Pflanzperiode',
        '#options' => DrupalBaumspendenConfig::getPlantPeriods(),
        '#empty_option' => '- Auswählen -',
        '#required' => true,
        '#ajax' => [
            'wrapper' => 'baumspenden-plant-info',
            'callback' => '_baumspenden_donation_plant_info',
        ],
    ];
    if (isset($form_state['values']['plant_period'])) {
        $form['plant_info']['plant_region'] = [
            '#type' => 'select',
            '#title' => 'Region',
            '#options' => DrupalBaumspendenConfig::getPlantRegions(
                $form_state['values']['plant_period']
            ),
            '#required' => true,
            '#ajax' => [
                'wrapper' => 'baumspenden-plant-info',
                'callback' => '_baumspenden_donation_plant_info',
            ],
        ];
    }
    if (isset($form_state['values']['plant_region'])) {
        $form['plant_info']['plant_tree'] = [
            '#type' => 'select',
            '#title' => 'Baumart',
            '#options' => DrupalBaumspendenConfig::getTreeSpecies(
                $form_state['values']['plant_period']
            ),
            '#required' => true,
        ];
    }
    $form['plant_info']['update'] = [
        '#type' => 'submit',
        '#value' => t('Update'),
        '#attributes' => [
            'class' => [
                'hide-js',
            ],
        ],
        '#attached' => [
            'css' => [
                drupal_get_path(
                    'module',
                    'baumspenden'
                ) . '/css/baumspende.css',
            ],
        ],
        // Only validate related fields.
        '#limit_validation_errors' => [
            ['plant_period'],
            ['plant_region'],
        ],
        // Required when using #limit_validation_errors.
        '#submit' => [
            'baumspenden_donation_submit',
        ],
    ];

    $form['contact'] = [
        '#type' => 'fieldset',
        '#title' => 'Meine Kontaktdaten',
    ];
    $form['contact']['first_name'] = [
        '#type' => 'textfield',
        '#title' => 'Vorname',
        '#required' => true,
    ];
    $form['contact']['last_name'] = [
        '#type' => 'textfield',
        '#title' => 'Nachname',
        '#required' => true,
    ];
    $form['contact']['street_address'] = [
        '#type' => 'textfield',
        '#title' => 'Straße, Hausnummer',
        '#required' => true,
    ];
    $form['contact']['postal_code'] = [
        '#type' => 'textfield',
        '#title' => 'Postleitzahl',
        '#required' => true,
    ];
    $form['contact']['city'] = [
        '#type' => 'textfield',
        '#title' => 'Ort',
        '#required' => true,
    ];
    $form['contact']['email'] = [
        '#type' => 'textfield',
        '#title' => 'E-Mail-Adresse',
        '#required' => true,
    ];

    $form['shipping_mode'] = [
        '#type' => 'select',
        '#title' => 'Versandoption',
        '#options' => [
            'email' => 'als PDF per E-Mail',
            'postal' => 'postalisch',
            'none' => 'kein Zertifikat',
        ],
    ];

    $form['certificate_name'] = [
        '#type' => 'textfield',
        '#title' => 'Name auf Zertifikat',
        '#description' => 'max. 40 Zeichen',
        '#attributes' => [
            'placeholder' => 'Waldmariechen',
        ],
        '#maxlength' => 40,
    ];

    $form['newsletter'] = [
        '#type' => 'checkbox',
        '#title' => 'Newsletter abonnieren',
        '#description' => 'Newsletter mit aktuellen Themen rund um das Bergwaldprojekt',
    ];

    $form['gdpr_consent'] = [
        '#type' => 'checkbox',
        '#title' => 'Datenschutz',
        '#description' => 'Ich habe die <a href="' . variable_get(
                'baumspenden_gdpr_link',
                '/datenschutz'
            ) . '" target="_blank">Datenschutzerklärung</a> gelesen und akzeptiere diese.',
        '#required' => true,
    ];

    $form['actions'] = [
        '#type' => 'actions',
    ];
    $form['actions']['submit'] = [
        '#type' => 'submit',
        '#value' => 'Vorschau',
    ];

    return $form;
}

/**
 * Validates form submissions for the "baumspenden_donation" form.
 *
 * @param $form
 * @param $form_state
 */
function baumspenden_donation_validate($form, &$form_state)
{
    // Require a valid e-mail address.
    if (!valid_email_address($form_state['values']['email'])) {
        form_set_error(
            'email',
            'Bitte geben Sie eine gültige E-Mail-Adresse ein.'
        );
    }
}

/**
 * Processes form submissions for the "baumspenden_donation" form.
 *
 * @param $form
 * @param $form_state
 */
function baumspenden_donation_submit($form, &$form_state)
{
    // Depend on which element trigered the submission.
    switch ($form_state['triggering_element']['#value']) {
        case $form['actions']['submit']['#value']:
            // Regular form submission.
            // TODO: Process form.
            break;
        case $form['plant_info']['update']['#value']:
            // Updating plant info fields. Simply rebuild the form.
            $form_state['rebuild'] = true;
            break;
    }
}

/**
 * Returns plant info elements of the "baumspenden_donation" form to be replaced
 * by an Ajax request.
 *
 * @param $form
 *
 * @return mixed
 */
function _baumspenden_donation_plant_info($form)
{
    return $form['plant_info'];
}
